<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Copo 23 â€“ Progress Portal</title>
<meta name="theme-color" content="#0b2a3a"/>
<style>
:root{
  --ink:#0f172a;
  --ink2:#1f2937;
  --bg:#f5f6f8;
  --card:#ffffff;
  --muted:#64748b;
  --line:#e5e7eb;
  --good:#16a34a;
  --warn:#f59e0b;
  --bad:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#101828}
a{color:inherit}
header{
  position:sticky;top:0;z-index:20;
  background:#ffffff;
  border-bottom:1px solid var(--line);
  box-shadow:0 6px 18px rgba(15,23,42,.06);
  padding:14px 16px;
  display:flex;gap:12px;align-items:center;justify-content:space-between
}
.brand{display:flex;gap:10px;align-items:center;min-width:220px}
.brand img.logo{
  height:40px;
  width:auto;
  display:block;
  border-radius:8px;
  background:#ffffff;
  padding:6px;
  border:1px solid var(--line);
}
.brand .t{display:flex;flex-direction:column;gap:2px}
.brand .t strong{font-size:15px;line-height:1.1;letter-spacing:.2px}
.brand .t span{font-size:12px;opacity:.85}
.actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
button,input,select,textarea{font:inherit}
button{border:0;border-radius:12px;padding:10px 12px;background:#ffffff1f;color:#fff;backdrop-filter: blur(6px);}
button.primary{background:#fff;color:var(--ink);font-weight:700}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.25)}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
.search{padding:10px 12px;border-radius:12px;border:1px solid var(--line);min-width:280px;background:#fff}
.tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tab{border:1px solid var(--line);background:#fff;color:var(--ink);padding:9px 12px;border-radius:999px;font-weight:700}
.tab.active{background:var(--ink);color:#fff;border-color:transparent}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:18px;box-shadow:0 4px 14px rgba(16,24,40,.06);
  overflow:hidden;cursor:pointer;user-select:none;
  transition:transform .08s ease, box-shadow .18s ease, border-color .18s ease;
}
.card:active{transform:scale(.99);border-color:#c6d3df}
.card:hover{box-shadow:0 10px 26px rgba(16,24,40,.10)}
.cover{
  height:128px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  background:linear-gradient(135deg, rgba(15,23,42,.10), rgba(15,23,42,.02));
}
.cover .icon{
  font-size:34px;
  position:absolute;
  left:14px;
  top:12px;
  opacity:.9;
  filter:grayscale(.2);
}
.cover .cap{
  position:absolute;
  right:14px;
  top:12px;
  font-size:12px;
  letter-spacing:.12em;
  text-transform:uppercase;
  color:rgba(15,23,42,.70);
  background:rgba(255,255,255,.70);
  border:1px solid rgba(229,231,235,.9);
  padding:6px 10px;
  border-radius:999px;
}
.cap{border:1px solid var(--line);background:#fff;border-radius:999px;padding:5px 10px;font-size:12px;color:var(--ink);font-weight:800}
.cover .ctitle{
  padding:0 18px;
  text-align:center;
  font-weight:900;
  color:var(--ink);
  letter-spacing:.2px;
  font-size:18px;
  line-height:1.12;
}
.body{padding:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.muted{color:var(--muted);font-size:13px}
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:5px 10px;border-radius:999px;font-size:12px;background:#fbfcfd;font-weight:700;color:#111827}
.pill.good{border-color:#abefc6;background:#ecfdf3;color:#027a48}
.pill.bad{border-color:#fda29b;background:#fff5f5;color:#b42318}
.pill.warn{border-color:#fedf89;background:#fffaeb;color:#b54708}
.progress{height:10px;background:#edf2f6;border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:linear-gradient(90deg,var(--ink),var(--ink2));width:0%}
.kpi{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.kpi{grid-template-columns:1fr 1fr}}
.kpi .box{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 4px 14px rgba(16,24,40,.04)}
.kpi h3{margin:0 0 8px 0;font-size:14px;color:#101828}
.kpi .big{font-size:28px;font-weight:900;color:var(--ink);line-height:1}
.kpi .sub{margin-top:6px;color:var(--muted);font-size:13px}
.hr{height:1px;background:var(--line);margin:10px 0}

.modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.48);padding:10px;z-index:50}
.sheet{width:min(1000px,100%);max-height:92vh;background:#fff;border-radius:20px;overflow:hidden;border:1px solid var(--line)}
.sheet header{position:unset;background:#fff;color:#101828;border-bottom:1px solid var(--line)}
.sheet header .actions button{background:#edf2f6;color:var(--ink)}
.sheet .content{padding:12px;overflow:auto;max-height:calc(92vh - 58px)}
.list{display:flex;flex-direction:column;gap:10px}
.item{border:1px solid var(--line);border-radius:16px;padding:10px}
.item h4{margin:0 0 6px 0;font-size:14px}
.meta{display:flex;gap:10px;flex-wrap:wrap}
.meta span{font-size:12px;color:var(--muted)}
.controls{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.range{display:flex;align-items:center;gap:10px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px}
.range input{width:190px}
.select{padding:9px 10px;border-radius:12px;border:1px solid var(--line);background:#fff}
.note{width:100%;min-height:62px;border:1px solid var(--line);border-radius:12px;padding:10px}
.badge{min-width:54px;text-align:right;font-weight:900;color:var(--ink)}
.small{font-size:12px;color:var(--muted)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#101828;color:#fff;padding:10px 12px;border-radius:999px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .18s ease}
.toast.show{opacity:1}

.card:focus-visible{outline:3px solid rgba(15,23,42,.18);outline-offset:2px}
.card.clicked{border-color:rgba(15,23,42,.28)}
.pill:not(.good):not(.warn):not(.bad){background:#f8fafc;border:1px solid var(--line);color:var(--ink2)}
.pill.positive{background:rgba(22,163,74,.10);border-color:rgba(22,163,74,.25);color:#14532d}
.pill.negative{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.25);color:#7f1d1d}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img class="logo" alt="NVM" src="./NVM_logo.png" onerror="this.onerror=null;this.src='./NVM_logo_inverted_2.png';" />
    <div class="t">
      <strong id="pName">Progress Portal</strong>
      <span id="pMeta">Loadingâ€¦</span>
    </div>
  </div>
  <div class="actions">
    <div class="tabs" aria-label="tabs">
      <button class="tab active" id="tabProgress" type="button">Progress</button>
      <button class="tab" id="tabSchedule" type="button">Schedule</button>
    </div>
    <button id="btnAdmin" class="primary" type="button">Edit mode: OFF</button>
    <button id="btnExport" class="ghost" type="button">Export state</button>
    <button id="btnImport" class="ghost" type="button">Import state</button>
  </div>
</header>

<div class="wrap">
  <div class="toolbar">
    <input id="search" class="search" placeholder="Search by code or descriptionâ€¦" />
    <div class="row">
      <span class="pill" id="overallPill">Overall: 0%</span>
      <span class="pill" id="pacePill">Pace: â€”</span>
    </div>
  </div>

  <div id="viewProgress">
    <div class="grid" id="chaptersGrid"></div>
  </div>

  <div id="viewSchedule" style="display:none">
    <div class="kpi">
      <div class="box">
        <h3>Time tracking</h3>
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div class="big" id="kpiWeek">â€”</div>
            <div class="sub" id="kpiElapsed">Set a start date to calculate elapsed time.</div>
          </div>
          <div style="min-width:180px">
            <label class="small">Project start date</label>
            <input id="startDate" type="date" class="select" style="width:100%"/>
          </div>
        </div>
      </div>

      <div class="box">
        <h3>Plan vs actual</h3>
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div class="big" id="kpiDelta">â€”</div>
            <div class="sub" id="kpiPlanActual">Planned: â€” Â· Actual: â€”</div>
          </div>
          <div>
            <div class="pill" id="kpiEta">ETA: â€”</div>
          </div>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="box" style="background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Weekly timeline (auto)</h3>
        <span class="muted">Based on planned weeks per item. Updates using progress %.</span>
      </div>
      <div class="hr"></div>
      <div id="weeksList" class="list"></div>
    </div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="sheet">
    <header>
      <div class="brand" style="min-width:unset">
        <div class="t">
          <strong id="mTitle">Chapter</strong>
          <span id="mSub" class="muted">Items</span>
        </div>
      </div>
      <div class="actions">
        <select id="filterStatus" class="select" aria-label="filter">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="in_progress">In progress</option>
          <option value="done">Done</option>
          <option value="blocked">Blocked</option>
        </select>
        <button id="btnClose" type="button">Close</button>
      </div>
    </header>
    <div class="content">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <span class="pill" id="mCount"></span>
          <span class="pill" id="mAvg"></span>
        </div>
        <div class="muted" id="mHint">Edit mode OFF (read-only).</div>
      </div>
      <div class="hr"></div>
      <div class="list" id="itemsList"></div>
    </div>
  </div>
</div>

<input type="file" id="importFile" accept="application/json" style="display:none"/>
<div class="toast" id="toast">Saved</div>

<script>
const LS_PIN = "copo23_admin_pin_v2";
const LS_START = "copo23_start_date_v2";
const LS_DRAFT = "copo23_draft_state_v2";

let DATA=null;
let SERVER_STATE=null;
let STATE=null;        // working state (may be draft)
let isAdmin=false;
let currentChapter=null;

const el=(id)=>document.getElementById(id);
const toastEl=el("toast");

function toast(msg){
  toastEl.textContent=msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 900);
}

function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function fmtDate(d){return d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});}
function pct(n){return Math.round(clamp(n,0,100));}

function fmtStatus(s){ return ({pending:"Pending",in_progress:"In progress",done:"Done",blocked:"Blocked"})[s]||"Pending"; }
function statusPillClass(s){ return ({done:"good",blocked:"bad",in_progress:"warn",pending:""})[s]||""; }

function getItemState(id){ return (STATE?.items?.[id]) || {status:"pending",progress:0,note:"",updatedAt:null}; }
function getItemProgress(id){ return pct(getItemState(id).progress||0); }
function getItemStatus(id){ return getItemState(id).status||"pending"; }

function chapterProgress(ch){
  if(!ch.items.length) return 0;
  let sum=0;
  for(const it of ch.items) sum += getItemProgress(it.id);
  return Math.round(sum/ch.items.length);
}

function overallProgress(){
  let sum=0, n=0;
  for(const ch of DATA.chapters){
    for(const it of ch.items){ sum += getItemProgress(it.id); n++; }
  }
  return n? Math.round(sum/n):0;
}

async function loadJSON(path){
  const res = await fetch(path + "?t=" + Date.now(), {cache:"no-store"});
  if(!res.ok) throw new Error(path + " " + res.status);
  return await res.json();
}

function pickWorkingState(){
  // By default viewers see server state. Admin sees draft (if exists) or server state.
  if(isAdmin){
    const draftRaw = localStorage.getItem(LS_DRAFT);
    if(draftRaw) {
      try{ STATE = JSON.parse(draftRaw); return; }catch(_){}
    }
  }
  STATE = JSON.parse(JSON.stringify(SERVER_STATE));
}

function saveDraft(){
  if(!isAdmin) return;
  localStorage.setItem(LS_DRAFT, JSON.stringify(STATE));
}

function setTab(name){
  const prog = name==="progress";
  el("viewProgress").style.display = prog ? "" : "none";
  el("viewSchedule").style.display = prog ? "none" : "";
  el("tabProgress").classList.toggle("active", prog);
  el("tabSchedule").classList.toggle("active", !prog);
  if(!prog) renderSchedule();
}

function setAdmin(on){
  isAdmin = on;
  el("btnAdmin").textContent = "Edit mode: " + (on ? "ON" : "OFF");
  el("mHint").textContent = on ? "Edit mode ON (changes are local until you export)." : "Edit mode OFF (read-only).";
  pickWorkingState();
  renderGrid();
  if(currentChapter) renderModal(currentChapter);
  renderSchedule();
}

function askPinAndEnable(){
  if(isAdmin){ setAdmin(false); return; }
  const saved = localStorage.getItem(LS_PIN);
  if(!saved){
    const pin = prompt("Create an admin PIN (4â€“8 digits):");
    if(!pin || pin.length < 4) return;
    localStorage.setItem(LS_PIN, pin);
    setAdmin(true);
    toast("Admin PIN set");
    return;
  }
  const pin = prompt("Enter admin PIN:");
  if(pin === saved){ setAdmin(true); toast("Edit mode ON"); }
  else alert("Wrong PIN");
}

function renderGrid(){
  el("pName").textContent = DATA.project.name;
  el("pMeta").textContent = `Generated: ${DATA.project.generated_at} Â· Duration: ${DATA.project.duration_weeks} weeks`;
  const ov = overallProgress();
  el("overallPill").textContent = `Overall: ${ov}%`;

  const q = (el("search").value||"").trim().toLowerCase();
  const grid = el("chaptersGrid");
  grid.innerHTML="";

  for(const ch of DATA.chapters){
    const matches = !q ? ch.items : ch.items.filter(it =>
      (it.code||"").toLowerCase().includes(q) || (it.description||"").toLowerCase().includes(q)
    );
    if(q && !matches.length) continue;

    const p = chapterProgress(ch);

    const card = document.createElement("div");
    card.className="card";
    card.tabIndex=0;
    card.setAttribute("role","button");
    card.dataset.chapter = ch.chapter_no;

    const cap = String(ch.chapter_no).padStart(2,"0");
    card.innerHTML = `
      <div class="cover">
        <div class="icon">${ch.icon||"ðŸ“Œ"}</div>
        <div class="cap">CH ${cap}</div>
        <div class="ctitle">${ch.title}</div>
      </div>
      <div class="body">
        <div class="row" style="justify-content:space-between;align-items:center">
          <span class="pill">${ch.items.length} items</span>
          <span class="pill" data-ch-pill="${ch.chapter_no}">${p}%</span>
        </div>
        <div style="margin-top:10px" class="progress"><div data-ch-bar="${ch.chapter_no}" style="width:${p}%"></div></div>
        <div class="muted" style="margin-top:10px">Tap to open</div>
      </div>
    `;
    card.addEventListener("click", ()=>{ card.classList.add("clicked"); setTimeout(()=>card.classList.remove("clicked"), 180); openModal(ch); });
    card.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ card.classList.add("clicked"); setTimeout(()=>card.classList.remove("clicked"), 180); openModal(ch);} });
    grid.appendChild(card);
  }

  renderScheduleKPIs();
}

function openModal(ch){ currentChapter=ch; el("modal").style.display="flex"; renderModal(ch); }
function closeModal(){ el("modal").style.display="none"; currentChapter=null; }

function renderModal(ch){
  const cap = String(ch.chapter_no).padStart(2,"0");
  el("mTitle").textContent = `CH ${cap} â€“ ${ch.title}`;
  el("mSub").textContent = "Items (no prices)";
  el("mCount").textContent = `${ch.items.length} items`;
  el("mAvg").textContent = `Average: ${chapterProgress(ch)}%`;

  const q = (el("search").value||"").trim().toLowerCase();
  const f = el("filterStatus").value;

  let its = ch.items.slice();
  if(q) its = its.filter(it => (it.code||"").toLowerCase().includes(q) || (it.description||"").toLowerCase().includes(q));
  if(f) its = its.filter(it => getItemStatus(it.id)===f);

  const list = el("itemsList");
  list.innerHTML="";

  for(const it of its){
    const st = getItemState(it.id);
    const prog = getItemProgress(it.id);
    const status = getItemStatus(it.id);

    const div = document.createElement("div");
    div.className="item";
    div.dataset.item = it.id;

    div.innerHTML = `
      <h4>${it.code} â€“ ${it.description}</h4>
      <div class="meta">
        <span>${(it.qty ?? "")} ${(it.unit ?? "")}</span>
        <span>Planned: week ${it.planned_week_start ?? "-"}â€“${it.planned_week_end ?? "-"}</span>
        <span>Status: <b data-status-text>${fmtStatus(status)}</b></span>
      </div>

      <div style="margin-top:8px" class="progress"><div data-bar style="width:${prog}%"></div></div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <span class="muted"><b data-prog-text>${prog}%</b> complete</span>
        <span class="pill ${statusPillClass(status)}" data-status-pill>${fmtStatus(status)}</span>
      </div>

      <div class="controls">
        <div class="range">
          <span class="small">Progress</span>
          <input ${isAdmin?"":"disabled"} data-prog type="range" min="0" max="100" value="${prog}"/>
          <span class="badge" data-prog-badge>${prog}%</span>
        </div>

        <select ${isAdmin?"":"disabled"} data-status class="select">
          <option value="pending">Pending</option>
          <option value="in_progress">In progress</option>
          <option value="done">Done</option>
          <option value="blocked">Blocked</option>
        </select>
      </div>

      <div style="margin-top:10px">
        <textarea ${isAdmin?"":"disabled"} data-note class="note" placeholder="Quick noteâ€¦">${(st.note||"").replaceAll("<","&lt;")}</textarea>
        <div class="small">Autosaves to your device in edit mode. Export to publish.</div>
      </div>
    `;
    list.appendChild(div);

    const sel = div.querySelector('[data-status]');
    sel.value = status;

    if(isAdmin){
      const progInput = div.querySelector('[data-prog]');
      const noteInput = div.querySelector('[data-note]');

      progInput.addEventListener("input", ()=>{
        const v = parseInt(progInput.value,10);
        applyItemUpdate(it.id, {progress:v}, div, ch.chapter_no);
      });

      sel.addEventListener("change", ()=>{
        applyItemUpdate(it.id, {status: sel.value}, div, ch.chapter_no);
      });

      let noteTimer=null;
      noteInput.addEventListener("input", ()=>{
        clearTimeout(noteTimer);
        noteTimer=setTimeout(()=>applyItemUpdate(it.id, {note: noteInput.value}, div, ch.chapter_no, false), 400);
      });
    }
  }
}

function applyItemUpdate(id, patch, rowEl, chapterNo, showToast=true){
  const prev = getItemState(id);
  const next = Object.assign({}, prev, patch, {updatedAt: new Date().toISOString()});
  if(!STATE.items) STATE.items={};
  STATE.items[id]=next;
  STATE.updated_at = new Date().toISOString();
  saveDraft();

  // Update row UI live (no re-render)
  if(rowEl){
    if(patch.progress !== undefined){
      const p = pct(patch.progress);
      rowEl.querySelector('[data-bar]').style.width = p + "%";
      rowEl.querySelector('[data-prog-text]').textContent = p + "%";
      rowEl.querySelector('[data-prog-badge]').textContent = p + "%";
    }
    if(patch.status){
      const st = patch.status;
      rowEl.querySelector('[data-status-text]').textContent = fmtStatus(st);
      const pill = rowEl.querySelector('[data-status-pill]');
      pill.textContent = fmtStatus(st);
      pill.className = "pill " + statusPillClass(st);
    }
  }

  // Update chapter card + modal header
  updateChapterUI(chapterNo);
  renderScheduleKPIs();

  if(showToast) toast("Saved");
}

function updateChapterUI(chapterNo){
  const ch = DATA.chapters.find(c=>c.chapter_no===chapterNo);
  if(!ch) return;
  const p = chapterProgress(ch);
  const pill = document.querySelector(`[data-ch-pill="${chapterNo}"]`);
  const bar  = document.querySelector(`[data-ch-bar="${chapterNo}"]`);
  if(pill) pill.textContent = p + "%";
  if(bar) bar.style.width = p + "%";
  if(currentChapter && currentChapter.chapter_no===chapterNo){
    el("mAvg").textContent = `Average: ${p}%`;
  }
  el("overallPill").textContent = `Overall: ${overallProgress()}%`;
}

function exportState(){
  const payload = STATE;
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "state.json";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("Exported state.json");
}

function importState(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const s=JSON.parse(reader.result);
      if(!s || typeof s!=="object" || !("items" in s)) throw new Error("Invalid state");
      SERVER_STATE = s;
      pickWorkingState();
      renderGrid();
      if(currentChapter) renderModal(currentChapter);
      renderSchedule();
      toast("Imported");
    }catch(e){ alert("Import failed: " + e.message); }
  };
  reader.readAsText(file);
}

function computeCurrentWeek(){
  const start = localStorage.getItem(LS_START);
  if(!start) return null;
  const startDate = new Date(start + "T00:00:00");
  const now = new Date();
  const days = Math.max(0, Math.floor((now - startDate) / (1000*60*60*24)));
  const weeksElapsed = Math.floor(days / 7);
  const wk = clamp(weeksElapsed + 1, 1, DATA.project.duration_weeks);
  return {wk, days, weeksElapsed, start};
}

function plannedOverallAtWeek(wk){
  let sum=0, n=0;
  for(const ch of DATA.chapters){
    for(const it of ch.items){
      const a = it.planned_week_start ?? 1;
      const b = it.planned_week_end ?? a;
      let exp=0;
      if(wk < a) exp=0;
      else if(wk > b) exp=100;
      else {
        const dur = Math.max(1, (b - a + 1));
        exp = ((wk - a + 1) / dur) * 100;
      }
      sum += exp; n++;
    }
  }
  return n ? Math.round(sum/n) : 0;
}

function renderScheduleKPIs(){
  const cw = computeCurrentWeek();
  const actual = overallProgress();
  if(!cw){
    el("pacePill").textContent = "Pace: set start date";
    el("pacePill").className = "pill";
    return;
  }
  const planned = plannedOverallAtWeek(cw.wk);
  const delta = actual - planned;
  let cls="pill", label="Pace: on track";
  if(delta > 5) { cls="pill good"; label=`Pace: +${delta}% ahead`; }
  else if(delta < -5) { cls="pill bad"; label=`Pace: ${delta}% behind`; }
  else { cls="pill warn"; label=`Pace: ${delta}% vs plan`; }

  el("pacePill").textContent = label;
  el("pacePill").className = cls;
}

function renderSchedule(){
  // load start date field
  let saved = localStorage.getItem(LS_START);
  if(!saved && DATA?.project?.start_date){
    saved = DATA.project.start_date;
    localStorage.setItem(LS_START, saved);
  }
  el("startDate").value = saved || "";

  renderScheduleKPIs();

  const cw = computeCurrentWeek();
  const weeksList = el("weeksList");
  weeksList.innerHTML="";

  const duration = DATA.project.duration_weeks;
  const actual = overallProgress();

  // KPIs
  if(!cw){
    el("kpiWeek").textContent = "â€”";
    el("kpiElapsed").textContent = "Set a start date to calculate elapsed time and pace.";
    el("kpiDelta").textContent = "â€”";
    el("kpiPlanActual").textContent = "Planned: â€” Â· Actual: â€”";
    el("kpiEta").textContent = "ETA: â€”";
  } else {
    const planned = plannedOverallAtWeek(cw.wk);
    const delta = actual - planned;
    el("kpiWeek").textContent = "Week " + cw.wk + " / " + duration;

    const startDate = new Date(cw.start + "T00:00:00");
    const endDate = new Date(startDate.getTime() + (duration*7*86400000) - 86400000);
    const daysTotal = duration*7;
    const daysRemaining = Math.max(0, daysTotal - cw.days);

    el("kpiElapsed").textContent = `${cw.days} days elapsed Â· ${daysRemaining} days remaining Â· ${fmtDate(startDate)} â†’ ${fmtDate(endDate)}`;
    el("kpiDelta").textContent = (delta>=0?"+":"") + delta + "%";
    el("kpiPlanActual").textContent = `Planned: ${planned}% Â· Actual: ${actual}%`;

    let etaText="ETA: â€”";
    if(actual > 0 && (cw.weeksElapsed+1) >= 1){
      const pacePerWeek = actual / (cw.weeksElapsed+1);
      const projWeeksTotal = Math.ceil(100 / Math.max(0.1, pacePerWeek));
      const projEnd = new Date(startDate.getTime() + (projWeeksTotal*7*86400000) - 86400000);
      etaText = `ETA: ${fmtDate(projEnd)} (~${projWeeksTotal} weeks)`;
    }
    el("kpiEta").textContent = etaText;
  }

  // Precompute items per week
  const byWeek = Array.from({length:duration+1}, ()=>[]);
  for(const ch of DATA.chapters){
    for(const it of ch.items){
      const a = it.planned_week_start ?? 1;
      const b = it.planned_week_end ?? a;
      for(let w=a; w<=b; w++) byWeek[w].push(it);
    }
  }

  for(let w=1; w<=duration; w++){
    const its = byWeek[w];
    const exp = plannedOverallAtWeek(w);

    // actual average for items active this week
    let sum=0;
    for(const it of its) sum += getItemProgress(it.id);
    const act = its.length ? Math.round(sum/its.length) : 0;

    const box=document.createElement("div");
    box.className="item";
    const isCurrent = cw && (w===cw.wk);
    if(isCurrent){ box.style.borderColor="#b3c8d6"; box.style.background="#f7fbff"; }

    box.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-weight:900;color:var(--ink)">Week ${w}</div>
        <div class="row">
          <span class="pill">Expected: ${exp}%</span>
          <span class="pill">Active items: ${its.length}</span>
        </div>
      </div>
      <div style="margin-top:10px" class="progress"><div style="width:${act}%"></div></div>
      <div class="muted" style="margin-top:8px">Actual (active items avg): <b>${act}%</b></div>
      <details style="margin-top:8px">
        <summary class="muted">Show items</summary>
        <div class="hr"></div>
        <div class="small">
          ${its.slice(0,24).map(it=>`â€¢ ${it.code} â€“ ${it.description}`).join("<br/>")}
          ${its.length>24 ? "<br/><br/>â€¦and more" : ""}
        </div>
      </details>
    `;
    weeksList.appendChild(box);
  }
}

function setStartDate(v){
  if(!v){ localStorage.removeItem(LS_START); toast("Start date cleared"); }
  else { localStorage.setItem(LS_START, v); toast("Start date saved"); }
  renderSchedule();
}

// Events
el("btnAdmin").addEventListener("click", askPinAndEnable);
el("btnExport").addEventListener("click", exportState);
el("btnImport").addEventListener("click", ()=>el("importFile").click());
el("importFile").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(f) importState(f); e.target.value=""; });
el("tabProgress").addEventListener("click",()=>setTab("progress"));
el("tabSchedule").addEventListener("click",()=>setTab("schedule"));
el("btnClose").addEventListener("click", closeModal);
el("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal(); });
el("search").addEventListener("input",()=>{ renderGrid(); if(currentChapter) renderModal(currentChapter); });
el("filterStatus").addEventListener("change",()=>{ if(currentChapter) renderModal(currentChapter); });
el("startDate").addEventListener("change",(e)=>setStartDate(e.target.value));

async function boot(){
  DATA = await loadJSON("./data.json");
  try{ SERVER_STATE = await loadJSON("./state.json"); }
  catch(_e){ SERVER_STATE = {version:1, updated_at:null, items:{}}; }

  setAdmin(false);
  setTab("progress");
  renderGrid();
  renderSchedule();
}
boot();
</script>
</body>
</html>
