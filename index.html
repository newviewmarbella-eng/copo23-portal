<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Copo 23 (El Saladillo) – Progress Portal</title>
<meta name="theme-color" content="#0b2a3a"/>
<style>
:root{--ink:#0b2a3a;--bg:#f6f7f9;--card:#ffffff;--muted:#667085;--line:#e7ebf0;--shadow:0 6px 20px rgba(0,0,0,.08);}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#101828}
a{color:inherit}
/* Header */
header{background:var(--ink);color:#fff;display:flex;flex-direction:column;align-items:center;padding:16px 14px 12px}
.header-logo{width:100%;display:flex;align-items:center;justify-content:center}
.header-logo img{width:100%;max-width:520px;height:auto;object-fit:contain;display:block}
.header-title{text-align:center;padding:10px 8px 4px}
.header-title h1{margin:0;font-size:20px;letter-spacing:.1px;font-weight:800}
.header-nav{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;padding:10px 4px 0}
.navbtn{border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.10);color:#fff;border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer;transition:transform .08s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease}
.navbtn:hover{background:rgba(255,255,255,.14);box-shadow:0 6px 16px rgba(0,0,0,.12)}
.navbtn:active{transform:scale(.97)}
.navbtn.active{background:#fff;color:var(--ink);border-color:#fff;box-shadow:0 6px 20px rgba(0,0,0,.15)}
.navbtn.ghost{background:transparent}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
/* Cards */
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden;cursor:pointer;transition:transform .16s ease, box-shadow .2s ease}
.card:hover{transform:translateY(-2px)}
.card:active{transform:scale(.97)}
.cover{height:210px;position:relative;display:flex;flex-direction:column;justify-content:space-between;padding:12px;border-radius:18px;overflow:hidden;background:#0b2a3a}
.cover img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
.cover>*{position:relative;z-index:1}
.cover::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg, rgba(11,42,58,.18) 0%, rgba(11,42,58,.8) 100%)}
.cover .capno{position:relative;z-index:1;align-self:flex-start;background:rgba(255,255,255,.96);color:var(--ink);border-radius:999px;padding:7px 12px;font-weight:800;font-size:12px;box-shadow:0 10px 24px rgba(0,0,0,.18)}
.cover .title{position:relative;z-index:1;color:#fff;font-weight:900;font-size:18px;line-height:1.2;text-shadow:0 2px 10px rgba(0,0,0,.35)}
.cover .cardMeta{position:relative;z-index:1;display:flex;flex-direction:column;gap:10px;margin-top:auto}
.cover .cardMeta .row{align-items:center}
.cardMeta .muted-light{color:rgba(255,255,255,.85);font-size:13px}
.cardMeta .pill{background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.28);color:#fff}
.cardMeta .progress{height:10px;background:rgba(255,255,255,.22)}
.cardMeta .progress>div{background:#fff}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.muted{color:var(--muted);font-size:13px}
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:4px 10px;border-radius:999px;font-size:12px;background:#fbfcfd}
.progress{height:9px;background:#eef2f6;border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:var(--ink);width:0%}
/* Toolbar */
.toolbar{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:12px}
.toolbar input{width:100%;padding:11px 12px;border-radius:14px;border:1px solid var(--line)}
.toolbar .hint{margin-top:8px}
/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.45);padding:10px;z-index:50}
.sheet{width:min(980px,100%);max-height:92vh;background:#fff;border-radius:18px;overflow:hidden;border:1px solid var(--line)}
.sheet header{background:#fff;color:#101828;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:12px 14px}
.sheet header h2{margin:0;font-size:16px}
.sheet .content{padding:12px;overflow:auto;max-height:calc(92vh - 56px)}
.list{display:flex;flex-direction:column;gap:10px}
.item{border:1px solid var(--line);border-radius:14px;padding:10px}
.item h4{margin:0 0 6px 0;font-size:14px}
.meta{display:flex;gap:8px;flex-wrap:wrap}
.meta span{font-size:12px;color:var(--muted)}
.controls{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.range{display:flex;gap:10px;align-items:center;border:1px solid var(--line);background:#fbfcfd;border-radius:14px;padding:6px 10px}
.range input{width:200px}
select, textarea, button{font:inherit}
select{padding:10px;border-radius:14px;border:1px solid var(--line)}
textarea{width:100%;min-height:56px;border-radius:14px;border:1px solid var(--line);padding:10px}
.smallbtn{padding:9px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;color:var(--ink);font-weight:800;cursor:pointer}
.smallbtn:active{transform:scale(.98)}
.statusDone{border-color:#abefc6;background:#ecfdf3}
.statusBlocked{border-color:#fda29b;background:#fff5f5}
.badge{font-weight:900}
/* Views */
.view{display:none}
.view.active{display:block}
/* Schedule */
.kpis{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
@media(min-width:860px){.kpis{grid-template-columns:1fr 1fr 1fr}}
.kpi{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:12px}
.kpi .big{font-size:22px;font-weight:1000}
.table{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden;margin-top:12px}
.table table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
.table th{background:#fbfcfd;font-weight:900}
.notice{background:#0b2a3a10;border:1px solid var(--line);border-radius:18px;padding:12px;margin-top:12px}
.notice strong{font-weight:900}
/* Toast */
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#101828;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:60}
.toast.show{opacity:1}
code{background:#10182810;padding:2px 6px;border-radius:8px}
</style>
</head>
<body>
<header>
  <div class="header-logo">
    <img id="brandLogo" src="NVM_logo_inverted_2.png" alt="NVM logo" onerror="this.onerror=null;this.src='NVM_logo.png';" />
  </div>
  <div class="header-title">
    <h1 id="projectTitle">Copo 23 (El Saladillo) – Progress Portal</h1>
  </div>
  <div class="header-nav">
    <button id="tabProgress" class="navbtn active" type="button">Progress</button>
    <button id="tabSchedule" class="navbtn" type="button">Schedule</button>
    <button id="btnAdmin" class="navbtn ghost" type="button">Edit mode: OFF</button>
  </div>
</header>

<div class="wrap">
  <section id="viewProgress" class="view active">
    <div class="toolbar">
      <input id="search" placeholder="Search items (code or description)..." />
      <div class="muted hint" id="statusLine"></div>
    </div>
    <div style="height:12px"></div>
    <div class="grid" id="chaptersGrid"></div>
  </section>

  <section id="viewSchedule" class="view">
    <div class="toolbar">
      <div class="row" style="justify-content:flex-start;gap:12px">
        <div>
          <div class="muted">Project start date</div>
          <input id="startDate" type="date" style="max-width:220px"/>
        </div>
        <div class="muted" style="align-self:flex-end" id="scheduleLine"></div>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="muted">Week now</div>
        <div class="big" id="kWeek">—</div>
        <div class="muted" id="kDays">—</div>
      </div>
      <div class="kpi">
        <div class="muted">Planned vs actual</div>
        <div class="big"><span id="kPlanned">—</span> / <span id="kActual">—</span></div>
        <div class="muted">Planned % / Actual %</div>
      </div>
      <div class="kpi">
        <div class="muted">Status</div>
        <div class="big" id="kStatus">—</div>
        <div class="muted" id="kDelta">—</div>
      </div>
    </div>

    <div class="table">
      <table>
        <thead>
          <tr>
            <th>Chapter</th>
            <th>Planned weeks</th>
            <th>Planned % (now)</th>
            <th>Actual %</th>
          </tr>
        </thead>
        <tbody id="scheduleTable"></tbody>
      </table>
    </div>

    <div class="notice" id="adminTools" style="display:none">
      <strong>Admin tools</strong>
      <div class="muted" style="margin-top:6px">To publish updates to clients, export <code>state.json</code> and upload it to your GitHub repo (replace the existing <code>state.json</code>).</div>
      <div class="row" style="justify-content:flex-start;margin-top:10px">
        <button id="btnExport" class="smallbtn" type="button">Export state.json</button>
        <button id="btnImport" class="smallbtn" type="button">Import state.json</button>
        <button id="btnResetDraft" class="smallbtn" type="button">Discard local draft</button>
      </div>
    </div>
  </section>
</div>

<div class="modal" id="modal">
  <div class="sheet">
    <header>
      <div>
        <h2 id="mTitle">Chapter</h2>
        <div class="muted" id="mSub"></div>
      </div>
      <button id="btnClose" class="smallbtn" type="button">Close</button>
    </header>
    <div class="content">
      <div class="row" style="justify-content:flex-start;gap:10px">
        <span class="pill" id="mCount"></span>
        <span class="pill" id="mAvg"></span>
        <select id="filterStatus">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="in_progress">In progress</option>
          <option value="done">Done</option>
          <option value="blocked">Blocked</option>
        </select>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="itemsList"></div>
    </div>
  </div>
</div>

<input type="file" id="importFile" accept="application/json" style="display:none"/>
<div class="toast" id="toast">Saved</div>

<script>
const IMAGE_FALLBACKS = {
  demolition: "https://images.unsplash.com/photo-1503389152951-9f343605f61e?auto=format&fit=crop&w=1400&q=60",
  foundations: "https://images.unsplash.com/photo-1503387762-592deb58ef4e?auto=format&fit=crop&w=1400&q=60",
  structure: "https://images.unsplash.com/photo-1504307651254-35680f356dfd?auto=format&fit=crop&w=1400&q=60",
  masonry: "https://images.unsplash.com/photo-1503387746306-4cc5c1c2b7f8?auto=format&fit=crop&w=1400&q=60",
  roofing: "https://images.unsplash.com/photo-1505843513577-22bb7d21e455?auto=format&fit=crop&w=1400&q=60",
  "windows-doors": "https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=1400&q=60",
  glazing: "https://images.unsplash.com/photo-1449158743715-0a90ebb6d2d8?auto=format&fit=crop&w=1400&q=60",
  painting: "https://images.unsplash.com/photo-1497366754035-f200968a6e72?auto=format&fit=crop&w=1400&q=60",
  installations: "https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?auto=format&fit=crop&w=1400&q=60",
  cleaning: "https://images.unsplash.com/photo-1581579184683-30fdec38aaf0?auto=format&fit=crop&w=1400&q=60",
  "swimming-pool": "https://images.unsplash.com/photo-1504222490345-c075b6008014?auto=format&fit=crop&w=1400&q=60",
  "quality-control": "https://images.unsplash.com/photo-1541888946425-d81bb19240f5?auto=format&fit=crop&w=1400&q=60",
  waste: "https://images.unsplash.com/photo-1582719478248-48d72b1b1a2b?auto=format&fit=crop&w=1400&q=60",
  safety: "https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=1400&q=60"
};
const DEFAULT_CHAPTER_PHOTO = "https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1400&q=60";
let DATA = null;

const LS_PIN = "copo23_admin_pin_v3";
const LS_ADMIN_SESSION = "copo23_admin_session_v3";
const LS_DRAFT = "copo23_state_draft_v3";
const LS_START = "copo23_start_date_v3";

const el = (id)=>document.getElementById(id);
let SERVER_STATE = null;
let STATE = null;
let currentChapter = null;
let isAdmin = false;
let activeTab = "progress";
let startDateDefault = "2025-12-11";

function pct(v){ return Math.max(0, Math.min(100, Math.round(v ?? 0))); }
function fmtStatus(s){ return ({pending:"Pending", in_progress:"In progress", done:"Done", blocked:"Blocked"})[s] || "Pending"; }
function statusPillClass(s){ return s==="done" ? "statusDone" : (s==="blocked" ? "statusBlocked" : ""); }
function hasPin(){ return !!localStorage.getItem(LS_PIN); }

function chapterImageSources(ch){
  const code = String(ch.chapter_no).padStart(2, "0");
  const tag = (ch.image_tag || "").toLowerCase() || "general";
  const sources = [
    `images/ch-${code}.jpg`,
    `images/ch-${code}.jpeg`,
    `images/ch-${code}.png`,
  ];

  sources.push(
    `images/${tag}.jpg`,
    `images/${tag}.jpeg`,
    `images/${tag}.png`
  );

  sources.push(IMAGE_FALLBACKS[tag] || DEFAULT_CHAPTER_PHOTO);
  return sources;
}

function applyImageFallback(img, sources){
  let idx = 1;
  const handler = () => {
    if(idx >= sources.length){
      img.removeEventListener("error", handler);
      return;
    }
    img.src = sources[idx++];
  };
  img.addEventListener("error", handler);
  img.src = sources[0];
}

function toast(msg){
  const t = el("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 1200);
}

function loadDraft(){
  if(!hasPin()) return null;
  try{
    const raw = localStorage.getItem(LS_DRAFT);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(_){ return null; }
}

function saveDraft(){
  if(!hasPin()) return;
  try{ localStorage.setItem(LS_DRAFT, JSON.stringify(STATE)); }catch(_){ }
  updateStatusLine();
}

function discardDraft(){
  localStorage.removeItem(LS_DRAFT);
  STATE = JSON.parse(JSON.stringify(SERVER_STATE));
  updateStatusLine();
  renderAll();
  toast("Local draft discarded");
}

function updateStatusLine(){
  const publishedAt = SERVER_STATE?.updated_at || "—";
  const pinSet = hasPin();
  const draft = pinSet ? loadDraft() : null;
  const localAt = draft?.updated_at || "—";

  let text = `Public view: published progress. Updated: ${publishedAt}`;
  if(pinSet){
    text = draft
      ? `Viewing LOCAL draft (this device). Published: ${publishedAt} · Local: ${localAt}`
      : `Viewing PUBLISHED progress. Updated: ${publishedAt}`;
  }

  el("statusLine").textContent = text;
  el("scheduleLine").textContent = text;
}

function getItemState(id){ return STATE?.items?.[id] || {status:"pending", progress:0, note:""}; }
function getItemProgress(id){ return pct(getItemState(id).progress); }
function getItemStatus(id){ return getItemState(id).status || "pending"; }

function chapterProgress(ch){
  if(!ch.items.length) return 0;
  let sum=0;
  for(const it of ch.items) sum += getItemProgress(it.id);
  return Math.round(sum/ch.items.length);
}

function overallProgress(){
  if(!DATA) return 0;
  let sum=0, n=0;
  for(const ch of DATA.chapters){
    for(const it of ch.items){ sum += getItemProgress(it.id); n++; }
  }
  return n ? Math.round(sum/n) : 0;
}

function setTab(tab){
  activeTab = tab;
  el("tabProgress").classList.toggle("active", tab==="progress");
  el("tabSchedule").classList.toggle("active", tab==="schedule");
  el("viewProgress").classList.toggle("active", tab==="progress");
  el("viewSchedule").classList.toggle("active", tab==="schedule");
}

function setAdmin(on){
  isAdmin = on;
  el("btnAdmin").textContent = "Edit mode: " + (on ? "ON" : "OFF");
  el("adminTools").style.display = on ? "block" : "none";
  if(currentChapter) renderModal(currentChapter);
}

function ensureAdminSessionValid(){
  const until = parseInt(localStorage.getItem(LS_ADMIN_SESSION) || "0", 10);
  return Date.now() < until;
}

function askPinAndEnable(){
  if(isAdmin){ setAdmin(false); return; }
  if(ensureAdminSessionValid()){ setAdmin(true); toast("Edit mode enabled"); return; }

  const saved = localStorage.getItem(LS_PIN);
  if(!saved){
    const pin = prompt("Create an admin PIN (4–8 digits):");
    if(!pin || pin.length < 4) return;
    localStorage.setItem(LS_PIN, pin);
    localStorage.setItem(LS_ADMIN_SESSION, String(Date.now() + 24*60*60*1000));
    setAdmin(true);
    toast("PIN saved. Edit mode enabled");
    return;
  }
  const pin = prompt("Enter admin PIN:");
  if(pin === saved){
    localStorage.setItem(LS_ADMIN_SESSION, String(Date.now() + 24*60*60*1000));
    setAdmin(true);
    toast("Edit mode enabled");
  }else{
    alert("Incorrect PIN");
  }
}

async function loadJSON(path){
  const res = await fetch(path + "?t=" + Date.now(), {cache:"no-store"});
  if(!res.ok) throw new Error(path + " " + res.status);
  return await res.json();
}

function pickInitialState(){
  if(!hasPin()) localStorage.removeItem(LS_DRAFT);
  const draft = loadDraft();
  if(draft && draft.items){
    STATE = draft;  // keep local draft on this device
  }else{
    STATE = JSON.parse(JSON.stringify(SERVER_STATE));
  }
}

function openModal(ch){
  currentChapter = ch;
  el("modal").style.display = "flex";
  renderModal(ch);
}
function closeModal(){
  el("modal").style.display = "none";
  currentChapter = null;
}

function renderGrid(){
  if(!DATA) return;
  const q = (el("search").value || "").trim().toLowerCase();
  const grid = el("chaptersGrid");
  grid.innerHTML = "";

  for(const ch of DATA.chapters){
    const matches = !q ? ch.items : ch.items.filter(it =>
      (it.code||"").toLowerCase().includes(q) || (it.description||"").toLowerCase().includes(q)
    );
    if(q && !matches.length) continue;

    const pctCh = chapterProgress(ch);
    const card = document.createElement("div");
    card.className = "card";
    const cover = document.createElement("div");
    cover.className = "cover";

    const imgEl = document.createElement("img");
    imgEl.className = "cover-img";
    imgEl.loading = "lazy";
    imgEl.decoding = "async";
    imgEl.alt = `${ch.title} photo`;
    applyImageFallback(imgEl, chapterImageSources(ch));
    cover.appendChild(imgEl);

    const cap = document.createElement("div");
    cap.className = "capno";
    cap.textContent = `Chapter ${String(ch.chapter_no).padStart(2,"0")}`;
    cover.appendChild(cap);

    const meta = document.createElement("div");
    meta.className = "cardMeta";
    meta.innerHTML = `
      <div class="title">${ch.title}</div>
      <div class="row">
        <span class="pill"><span class="badge">${pctCh}%</span> complete</span>
        <span class="muted-light">${ch.items.length} items</span>
      </div>
      <div class="progress"><div style="width:${pctCh}%"></div></div>
    `;
    cover.appendChild(meta);

    card.appendChild(cover);
    card.addEventListener("click", ()=>openModal(ch));
    grid.appendChild(card);
  }
}

function renderModal(ch){
  el("mTitle").textContent = `Chapter ${String(ch.chapter_no).padStart(2,"0")} — ${ch.title}`;
  el("mSub").textContent = isAdmin ? "Edit enabled on this device" : "Read-only view";
  el("mCount").textContent = `${ch.items.length} items`;
  el("mAvg").textContent = `Average: ${chapterProgress(ch)}%`;

  const q = (el("search").value || "").trim().toLowerCase();
  const f = el("filterStatus").value;

  let its = ch.items.slice();
  if(q) its = its.filter(it => (it.code||"").toLowerCase().includes(q) || (it.description||"").toLowerCase().includes(q));
  if(f) its = its.filter(it => getItemStatus(it.id) === f);

  const list = el("itemsList");
  list.innerHTML = "";

  for(const it of its){
    const s = getItemState(it.id);
    const prog = getItemProgress(it.id);
    const status = getItemStatus(it.id);

    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <h4>${it.code} — ${it.description}</h4>
      <div class="meta">
        <span>${(it.qty ?? "")} ${(it.unit ?? "")}</span>
        <span>Planned: week ${it.planned_week_start ?? "-"}–${it.planned_week_end ?? "-"}</span>
        <span>Status: <b data-status-text>${fmtStatus(status)}</b></span>
      </div>

      <div style="margin-top:8px" class="progress"><div data-bar style="width:${prog}%"></div></div>
      <div class="row" style="margin-top:6px">
        <span class="muted"><span class="badge" data-prog-text>${prog}%</span> complete</span>
        <span class="pill ${statusPillClass(status)}" data-status-pill>${fmtStatus(status)}</span>
      </div>

      <div class="controls">
        <div class="range">
          <span class="muted" style="min-width:78px">Progress</span>
          <input data-prog type="range" min="0" max="100" value="${prog}" ${isAdmin ? "" : "disabled"} />
          <span class="badge" data-prog-badge>${prog}%</span>
        </div>

        <select data-status ${isAdmin ? "" : "disabled"}>
          <option value="pending">Pending</option>
          <option value="in_progress">In progress</option>
          <option value="done">Done</option>
          <option value="blocked">Blocked</option>
        </select>
      </div>

      <div style="margin-top:8px">
        <textarea data-note placeholder="Notes..." ${isAdmin ? "" : "disabled"}>${(s.note||"").replaceAll("<","&lt;")}</textarea>
      </div>
    `;
    list.appendChild(row);
    row.querySelector('[data-status]').value = status;

    if(!isAdmin) continue;

    const progInput = row.querySelector('[data-prog]');
    const statusSel = row.querySelector('[data-status]');
    const noteInput = row.querySelector('[data-note]');

    const applyPatch = (patch) => {
      const id = it.id;
      const prev = getItemState(id);
      const next = Object.assign({}, prev, patch);
      STATE.items[id] = next;
      STATE.updated_at = new Date().toISOString();
      saveDraft();

      if(patch.progress !== undefined){
        const p = pct(patch.progress);
        row.querySelector('[data-bar]').style.width = p + "%";
        row.querySelector('[data-prog-text]').textContent = p + "%";
        row.querySelector('[data-prog-badge]').textContent = p + "%";
      }
      if(patch.status){
        const st = patch.status;
        row.querySelector('[data-status-text]').textContent = fmtStatus(st);
        const pill = row.querySelector('[data-status-pill]');
        pill.textContent = fmtStatus(st);
        pill.className = "pill " + statusPillClass(st);
      }

      el("mAvg").textContent = `Average: ${chapterProgress(ch)}%`;
      renderGrid();
      renderSchedule();
    };

    progInput.addEventListener("input", ()=>applyPatch({progress: parseInt(progInput.value,10)}));
    statusSel.addEventListener("change", ()=>applyPatch({status: statusSel.value}));
    noteInput.addEventListener("input", ()=>applyPatch({note: noteInput.value}));
  }
}

function weeksElapsed(startDateStr){
  const start = new Date(startDateStr + "T00:00:00");
  const now = new Date();
  const ms = now - start;
  const days = Math.max(0, Math.floor(ms / (1000*60*60*24)));
  const wk = Math.floor(days / 7) + 1;
  return {days, wk};
}

function plannedOverallAtWeek(wk){
  if(!DATA) return 0;
  let sum=0, n=0;
  for(const ch of DATA.chapters){
    for(const it of ch.items){
      const a = it.planned_week_start ?? 1;
      const b = it.planned_week_end ?? a;
      let exp=0;
      if(wk < a) exp=0;
      else if(wk > b) exp=100;
      else {
        const dur = Math.max(1, (b - a + 1));
        exp = ((wk - a + 1) / dur) * 100;
      }
      sum += exp; n++;
    }
  }
  return n ? Math.round(sum/n) : 0;
}

function renderSchedule(){
  if(!DATA) return;
  const start = el("startDate").value || startDateDefault;
  const {days, wk} = weeksElapsed(start);
  const planned = plannedOverallAtWeek(wk);
  const actual = overallProgress();
  const delta = actual - planned;

  el("kWeek").textContent = "Week " + wk;
  el("kDays").textContent = days + " days elapsed";
  el("kPlanned").textContent = planned + "%";
  el("kActual").textContent = actual + "%";

  let status="On track";
  if(delta > 5) status="Ahead";
  if(delta < -5) status="Behind";
  el("kStatus").textContent = status;
  el("kDelta").textContent = (delta>=0?"+":"") + delta + "% vs plan";

  const tbody = el("scheduleTable");
  tbody.innerHTML = "";
  for(const ch of DATA.chapters){
    const a = Math.min(...ch.items.map(i => i.planned_week_start ?? 1));
    const b = Math.max(...ch.items.map(i => i.planned_week_end ?? (i.planned_week_start ?? 1)));
    let sum=0;
    for(const it of ch.items){
      const ia = it.planned_week_start ?? 1;
      const ib = it.planned_week_end ?? ia;
      let exp=0;
      if(wk < ia) exp=0;
      else if(wk > ib) exp=100;
      else {
        const dur=Math.max(1,(ib-ia+1));
        exp=((wk-ia+1)/dur)*100;
      }
      sum += exp;
    }
    const plannedCh = Math.round(sum/ch.items.length);
    const actualCh = chapterProgress(ch);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>Chapter ${String(ch.chapter_no).padStart(2,"0")} — ${ch.title}</td>
      <td>Week ${a}–${b}</td>
      <td>${plannedCh}%</td>
      <td>${actualCh}%</td>
    `;
    tbody.appendChild(tr);
  }

  updateStatusLine();
}

function exportState(){
  const blob = new Blob([JSON.stringify(STATE, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "state.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function importState(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const s = JSON.parse(reader.result);
      if(!s || typeof s!=="object" || !("items" in s)) throw new Error("Invalid state.json");
      STATE = s;
      STATE.updated_at = STATE.updated_at || new Date().toISOString();
      saveDraft();
      renderAll();
      toast("State imported");
    }catch(e){
      alert("Could not import: " + e.message);
    }
  };
  reader.readAsText(file);
}

function renderAll(){
  if(!DATA) return;
  renderGrid();
  if(currentChapter) renderModal(currentChapter);
  renderSchedule();
}

async function boot(){
  try{ DATA = await loadJSON("./data.json"); }
  catch(_e){ DATA = {project:{}, chapters:[]}; }

  startDateDefault = DATA?.project?.start_date || startDateDefault;

  try{ SERVER_STATE = await loadJSON("./state.json"); }
  catch(_e){ SERVER_STATE = {version:1, updated_at:null, items:{}}; }

  pickInitialState();

  const start = localStorage.getItem(LS_START) || startDateDefault;
  el("projectTitle").textContent = DATA?.project?.name || "Project progress";
  el("startDate").value = start;
  el("startDate").addEventListener("change", ()=>{
    localStorage.setItem(LS_START, el("startDate").value);
    renderSchedule();
  });

  if(ensureAdminSessionValid()) setAdmin(true);

  updateStatusLine();
  renderAll();
}

el("tabProgress").addEventListener("click", ()=>setTab("progress"));
el("tabSchedule").addEventListener("click", ()=>setTab("schedule"));
el("btnAdmin").addEventListener("click", askPinAndEnable);

el("search").addEventListener("input", ()=>{ renderGrid(); if(currentChapter) renderModal(currentChapter); });
el("filterStatus").addEventListener("change", ()=>{ if(currentChapter) renderModal(currentChapter); });

el("btnClose").addEventListener("click", closeModal);
el("modal").addEventListener("click", (e)=>{ if(e.target.id==="modal") closeModal(); });

el("btnExport").addEventListener("click", exportState);
el("btnImport").addEventListener("click", ()=>el("importFile").click());
el("importFile").addEventListener("change", (e)=>{ const f=e.target.files?.[0]; if(f) importState(f); e.target.value=""; });
el("btnResetDraft").addEventListener("click", ()=>{ if(confirm("Discard local draft changes on this device?")) discardDraft(); });

boot();
</script>
</body>
</html>
